import{o as l,a as c,b as r,C as ee,_ as me,r as h,c as z,D as ye,j as fe,h as U,L as we,k as Ce,t as i,f as S,u as $,d as m,m as ke,w as G,p as C,F as Q,e as X,n as Y,g as Me,v as be,aa as _e}from"./index-SnOBJRe6.js";import{s as u,b as d,c as se,W as Se,a as Be,u as Te}from"./useUsersStore-DeqpMyJa.js";import{E as xe}from"./useBotsStore-CXWqdG9t.js";import{S as Ue,F as $e}from"./useFullScreen-BNunA2HP.js";import{C as De}from"./useKeyboardShortcuts-DkxLRe_B.js";const Ie={xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",fill:"none"};function Ae(e,s){return l(),c("svg",Ie,s[0]||(s[0]=[r("path",{fill:"#000","fill-rule":"evenodd",d:"M10.94 16.06a1.5 1.5 0 0 0 2.12 0l5.658-5.656a1.5 1.5 0 1 0-2.122-2.121L12 12.878 7.404 8.282a1.5 1.5 0 1 0-2.122 2.12l5.658 5.66z","clip-rule":"evenodd"},null,-1)]))}const Fe={render:Ae},y={readChannels(e={}){return u(d.get("/channels/",{params:e}))},createChannel(e){return u(d.post("/channels/",e))},readUserChannels(e={}){return u(d.get("/channels/",{params:e}))},readChannelById(e){return u(d.get(`/channels/${e}`))},updateChannel(e,s){return u(d.patch(`/channels/${e}`,s))},deleteChannel(e){return u(d.delete(`/channels/${e}`))},readChannelMessages(e,s,a){return u(d.get(`/channels/${e}/messages`,{params:{skip:s,limit:a}}))},subscribe(e,s){return u(d.post(`/channels/${e}/subscribe`,s))},unsubscribe(e,s){return u(d.post(`/channels/${e}/unsubscribe`,s))}},Ne=ee("channels",{state:()=>({channels:[],userChannels:[],messages:[],currentChannel:null}),actions:{async readChannels(){const e=await y.readChannels({skip:0});return e&&(this.channels=e.data),e},async readUserChannels(){const e=await y.readUserChannels({skip:0});return e&&(this.userChannels=e.data),e},async readChannelById(e){const s=await y.readChannelById(e);return s&&(this.currentChannel=s.data),s},async createChannel(e){const s=await y.createChannel(e);return s&&this.channels.push(s.data),s.data},async updateChannel(e,s){const a=await y.updateChannel(e,s);return a&&se(this.channels,e,a.data),a},async deleteChannel(e){const s=await y.deleteChannel(e);return s&&(this.channels=this.channels.filter(a=>a.id!==e)),s},async fetchMessagesByChannel(e,s,a){const w=await y.readChannelMessages(e,s,a);return w&&(this.messages=w.data),w},async subscribeToChannel(e,s){return await y.subscribe(e,s)},async unsubscribeToChannel(e,s){return await y.unsubscribe(e,s)},getWebSocketUrl(e,s){return`${Se}?channel_id=${e}&token=${s}`}}}),B={readMessages(e={}){return u(d.get("/messages/",{params:e}))},createMessage(e){const s=new FormData;for(const a in e)e.hasOwnProperty(a)&&s.append(a,e[a]);return u(d.post("/messages/",e,{headers:{"Content-Type":"multipart/form-data"}}))},sendMessage(e,s){const a=new FormData;return a.append("text",e),a.append("channel_id",s),u(d.post("/messages/send_message",a,{headers:{"Content-Type":"multipart/form-data"}}))},readMessage(e){return u(d.get(`/messages/${e}`))},updateMessage(e,s){return u(d.patch(`/messages/${e}`,s))},deleteMessage(e){return u(d.delete(`/messages/${e}`))}},We=ee("messages",{state:()=>({messages:[]}),actions:{async readMessages(e={}){const s=await B.readMessages(e);return s&&(this.messages=s.data),s},async createMessage(e){const s=await B.createMessage(e);return s&&this.messages.push(s.data),s},async readMessage(e){return await B.readMessage(e)},async updateMessage(e,s){const a=await B.updateMessage(e,s);return a&&se(this.messages,e,a.data),a},async deleteMessage(e){const s=await B.deleteMessage(e);return s&&(this.messages=this.messages.filter(a=>a.id!==e)),s},async sendMessage(e,s){return await B.sendMessage(e,s)}}}),He={class:"chat-header"},Ve={key:0,class:"header-actions"},Ee={key:0},ze={key:1},Oe=["onClick"],Le={key:0,class:"message-history"},Ze=["onClick"],je={key:1,class:"widget-banner"},Ke={style:{"margin-top":"10px"}},qe={class:"message-time"},Je={key:2,class:"message-details"},Pe={key:0,class:"message-details-params"},Re={key:1},Ge={key:0,class:"unread-indicator"},Qe={class:"input-container"},Xe={__name:"chatView",props:{channel:{type:Object,required:!0},showActions:{type:Boolean,default:!0}},emits:["close","edit"],setup(e,{emit:s}){const a=e,w=h(30),F=h(0),ne=We(),O=Ne(),N=Be(),te=Te(),W=h(a.channel.id),k=h(null),ae=h(null),f=h([]),M=h(""),p=h(null),T=h(null),H=h(!1),b=h(0),_=h(!0),D=z(()=>{var n;return(n=N.currentUser)==null?void 0:n.id}),re=z(()=>f.value),oe=z(()=>f.value.length%w.value===0||f.value.length===0),L=async()=>{await N.readCurrentUser(),ae.value=N.currentUser},V=async()=>{const n=await O.fetchMessagesByChannel(W.value,F.value,w.value),t=(n==null?void 0:n.data)||[];Array.isArray(t)?(f.value=[...t,...f.value],F.value+=w.value):console.error("fetchMessagesByChannel вернул не массив:",t)},le=async()=>{const n=p.value.scrollHeight,t=p.value.scrollTop,v=n-t;await V(),U(()=>{const o=p.value.scrollHeight-v;p.value.scrollTop=o})},Z=n=>{if(!n)return"Неизвестный тип";switch(n.type){case"bot":return n.name;case"user":return n.username;case"anonymous_user":return n.type;default:return"Неизвестный тип"}},ce=n=>Z(n.sender),ie=n=>Z(n.recipient),j=()=>{try{const n=te.accessToken;if(!n){console.error("Токен доступа отсутствует");return}const t=O.getWebSocketUrl(a.channel.id,n);k.value=new WebSocket(t),k.value.onmessage=v=>{let g=JSON.parse(v.data);f.value.some(A=>A.id===g.id)||(f.value.push(g),U(()=>{const A=g.sender_id!==D.value;_.value?x():A&&b.value++}))},k.value.onerror=v=>{console.error("WebSocket error:",v)},k.value.onclose=()=>{console.log("WebSocket connection closed")}}catch(n){console.error("Ошибка при установке WebSocket соединения:",n)}},K=async()=>{if(M.value.trim())try{const n=await ne.sendMessage(M.value,W.value);M.value="",U(()=>{x()})}catch(n){console.error("Ошибка отправки сообщения:",n)}},ue=n=>(n.endsWith("Z")||(n+="Z"),new Date(n).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone})),de=()=>{if(p.value){const{scrollTop:n,scrollHeight:t,clientHeight:v}=p.value,g=100;_.value=t-(n+v)<=g,_.value&&(b.value=0),H.value=!_.value}},x=()=>{p.value&&(p.value.scrollTop=p.value.scrollHeight,b.value=0,_.value=!0)},q=n=>{T.value===n?T.value=null:T.value=n},I=h(!1),he=()=>{I.value=!I.value},J=s,pe=()=>{J("close")},ve=()=>{J("edit",a.channel)},ge=async()=>{f.value=[],F.value=0,M.value="",T.value=null,H.value=!1,b.value=0,_.value=!0,W.value=a.channel.id,await L(),await V(),U(()=>{x()}),j()};return ye(()=>a.channel,(n,t)=>{n&&n.id!==(t==null?void 0:t.id)&&ge()},{deep:!0}),fe(async()=>{await L(),await V(),U(()=>{x()}),j()}),we(()=>{k.value&&k.value.close()}),(n,t)=>{var g;const v=Ce("BaseButton");return l(),c("div",{class:Y(["chat-container",{fullscreen:I.value}])},[r("div",He,[r("h2",null,i((g=e.channel)==null?void 0:g.name),1),e.showActions?(l(),c("div",Ve,[r("button",{onClick:ve},[S($(xe),{class:"icon edit-icon"})]),r("button",{onClick:he},[I.value?(l(),c("span",Ee,[S($(Ue))])):(l(),c("span",ze,[S($($e))]))]),r("button",{onClick:pe},[S($(De))])])):m("",!0)]),r("div",{ref_key:"messagesContainer",ref:p,class:"messages",onScroll:de},[oe.value?(l(),ke(v,{key:0,class:"btn-show-more",size:"small",styleType:"secondary",onClick:le},{default:G(()=>t[1]||(t[1]=[C(" Показать еще ")])),_:1})):m("",!0),(l(!0),c(Q,null,X(re.value,(o,A)=>{var P;return l(),c("div",{key:o.id,class:Y(["message",o.sender_id===D.value?"message-sender":"message-receiver"])},[r("span",{class:"message-author",onClick:E=>q(o.id)},i(o.sender_id===D.value?"":(P=o.sender)==null?void 0:P.name),9,Oe),o.sender_id!=D.value||o.recipient!=null?(l(),c("span",Le,i(ce(o))+" > "+i(ie(o)),1)):m("",!0),r("div",{class:"message-body",onClick:E=>q(o.id)},[r("span",null,i(o.text),1)],8,Ze),o.widget?(l(),c("div",je,[t[3]||(t[3]=r("p",null,[r("strong",null,"Виджет")],-1)),r("p",null,i(o.widget.name||"—"),1),r("p",Ke,[t[2]||(t[2]=r("strong",null,"ID:",-1)),C(" "+i(o.widget.id||"—"),1)])])):m("",!0),r("span",qe,i(ue(o.created_at)),1),T.value===o.id?(l(),c("div",Je,[r("p",null,[t[4]||(t[4]=r("strong",null,"Отправитель:",-1)),C(" "+i(o.sender_id||"—"),1)]),r("p",null,[t[5]||(t[5]=r("strong",null,"Получатель:",-1)),C(" "+i(o.recipient_id||"—"),1)]),o.params&&Object.keys(o.params).length>0?(l(),c("div",Pe,[t[6]||(t[6]=r("p",null,[r("strong",null,"Параметры:")],-1)),r("ul",null,[(l(!0),c(Q,null,X(o.params,(E,R)=>(l(),c("li",{key:R},i(R)+": "+i(E),1))),128))])])):m("",!0),o.widget?(l(),c("div",Re,[t[9]||(t[9]=r("p",{style:{"text-decoration":"underline"}},[r("strong",null,"Информация о виджете")],-1)),r("p",null,[t[7]||(t[7]=r("strong",null,"Название:",-1)),C(" "+i(o.widget.name||"—"),1)]),r("p",null,[t[8]||(t[8]=r("strong",null,"ID виджета:",-1)),C(" "+i(o.widget.id||"—"),1)])])):m("",!0)])):m("",!0)],2)}),128))],544),H.value?(l(),c("div",{key:0,class:"scroll-to-bottom-button",onClick:x},[S($(Fe)),b.value>0?(l(),c("span",Ge,i(b.value),1)):m("",!0)])):m("",!0),r("div",Qe,[Me(r("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>M.value=o),placeholder:"Введите сообщение...",type:"text",onKeyup:_e(K,["enter"])},null,544),[[be,M.value]]),S(v,{size:"small",styleType:"secondary",class:"send-button",onClick:K},{default:G(()=>t[10]||(t[10]=[C(" Отправить ")])),_:1})])],2)}}},as=me(Xe,[["__scopeId","data-v-236d053d"]]);export{Fe as B,We as a,as as c,Ne as u};
