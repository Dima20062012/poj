import{_ as ee,r as h,c as P,o,a as u,b as s,d as B,F as j,e as X,t as y,f as b,w as J,g as re,v as ue,n as oe,T as ce,h as me,i as ne,j as le,k as _,u as i,l as U,m as C,p as Y,q as Q,s as pe,x as ve,y as fe,z as ae}from"./index-SnOBJRe6.js";import{u as se,E as be,T as _e}from"./useBotsStore-CXWqdG9t.js";import{s as Ce,F as ye}from"./pages.css_vue_type_style_index_0_src_true_lang-OrqQe0zQ.js";import"./useUsersStore-DeqpMyJa.js";import{u as ie,c as he}from"./chatView-CJiEovSS.js";import{u as ke,a as Be,f as te}from"./useSorting-Bi68fFlD.js";import{u as Se,F as Ve,S as ge}from"./useFullScreen-BNunA2HP.js";import{d as Z,u as $e,C as Ie,c as Me}from"./useKeyboardShortcuts-DkxLRe_B.js";import{u as we,c as Ee}from"./vuelidate-BXQAJ37Y.js";import{u as Te}from"./useGeneratedEntityName-CxA6RL77.js";const Fe={class:"bot-subscribers"},xe={class:"selected-bots"},De=["onClick"],ze=["onClick"],Ne={key:0,class:"add-panel"},Oe={key:0,class:"bot-list"},Ue=["onClick"],Le={class:"bot-avatar"},Re=["src"],Qe={key:1},je={class:"bot-name"},qe={key:1,class:"no-bots"},Ae={__name:"botSubscribers",props:{modelValue:Array},emits:["update:modelValue","input"],setup(q,{emit:$}){const m=q,S=$,V=se(),k=h(""),p=h(!1),g=P(()=>m.modelValue.filter(l=>l.type==="bot")),f=l=>g.value.some(d=>d.id===l),n=P(()=>V.bots.filter(l=>{var d;return!f(l.id)&&((d=l.name)==null?void 0:d.toLowerCase().includes(k.value.toLowerCase()))})),I=()=>{p.value=!p.value,p.value&&(k.value="",me(()=>{const l=document.querySelector(".search");l&&l.focus()}))},M=l=>{if(!f(l.id)){const d={...l,type:"bot"},a=[...m.modelValue,d];S("update:modelValue",a),S("input",a),k.value=""}},z=l=>{const d=m.modelValue.filter(a=>a.id!==l.id);S("update:modelValue",d),S("input",d)},L=l=>{window.open(`/bot/${l}`,"_blank")};return(l,d)=>(o(),u("div",Fe,[d[1]||(d[1]=s("label",{class:"label"},"Подписчики (агенты)",-1)),s("div",xe,[p.value?B("",!0):(o(),u("button",{key:0,class:"add-btn",onClick:I},"Добавить")),(o(!0),u(j,null,X(g.value,a=>(o(),u("div",{key:a.id,class:"bot-chip"},[s("div",{class:"bot-name-clickable",onClick:N=>L(a.id)},y(a.name||a.id),9,De),s("span",{class:"remove",onClick:N=>z(a)},"×",8,ze)]))),128))]),b(ce,{name:"fade"},{default:J(()=>[p.value?(o(),u("div",Ne,[re(s("input",{class:"search",placeholder:"поиск...","onUpdate:modelValue":d[0]||(d[0]=a=>k.value=a),autofocus:""},null,512),[[ue,k.value]]),n.value.length?(o(),u("div",Oe,[(o(!0),u(j,null,X(n.value,a=>(o(),u("div",{key:a.id,class:oe(["bot-item",{disabled:f(a.id)}]),onClick:N=>M(a)},[s("span",Le,[a.avatar?(o(),u("img",{key:0,src:a.avatar,alt:""},null,8,Re)):(o(),u("span",Qe,y((a.name||a.id)[0]),1))]),s("span",je,y(a.name||a.id),1)],10,Ue))),128))])):(o(),u("div",qe,"Нет доступных агентов"))])):B("",!0)]),_:1})]))}},Je=ee(Ae,[["__scopeId","data-v-15e7ced0"]]),Pe={class:"modal-head"},We={class:"modal-name"},Ge={class:"modal-options"},He={class:"form-top"},Ke={class:"modal-actions"},Xe={key:1},Ye=ne({__name:"channelModal",props:{isEditMode:{type:Boolean},formData:{},currentChannelId:{}},emits:["close"],setup(q,{emit:$}){const m=q,S=$,V=ie(),k=se(),p=h(!1),g=h(!1),f=h(!1),n=h({...Z,...m.formData}),I=we(Ee,n),{isFullScreen:M,toggleFullScreen:z,resetFullScreen:L}=Se(),l=P(()=>{const r=k.bots.map(e=>({label:e.name,value:e.id}));return r.unshift({label:"",value:""}),r}),d=()=>{p.value=!1,L(),S("close")},a=()=>{p.value?g.value=!0:d()},N=()=>{g.value=!1},A=async(r=!1)=>{if(r||p.value){if(!await I.value.$validate()){Q.error("Ошибка!");return}await R()}d()},R=async()=>{m.isEditMode&&m.currentChannelId?await G():await W()},W=async()=>{f.value=!0,await V.createChannel({name:n.value.name,description:n.value.description,is_public:n.value.is_public,default_bot_id:n.value.default_bot_id||null})&&(Q.success("Канал создан!"),f.value=!1,d())},G=async()=>{f.value=!0;let r={};try{n.value.variables&&(r=JSON.parse(n.value.variables))}catch{Q.error('Неверный формат JSON в поле "Переменные".');return}await w(),await V.updateChannel(m.currentChannelId,{...n.value,variables:{data:r}})&&(Q.success("Канал обновлен!"),f.value=!1,d())},H=h(m.formData.subscribers||[]),w=async()=>{var T,F;const r=((T=n.value.subscribers)==null?void 0:T.map(t=>t.id))||[],e=((F=H.value)==null?void 0:F.map(t=>t.id))||[],c=r.filter(t=>!e.includes(t)),E=e.filter(t=>!r.includes(t));c.length>0&&m.currentChannelId&&await V.subscribeToChannel(m.currentChannelId,c),E.length>0&&m.currentChannelId&&await V.unsubscribeToChannel(m.currentChannelId,E)},{generateName:K}=Te();return le(()=>{m.isEditMode||(n.value.name=K("канал"),p.value=!0)}),$e({onEscape:a,onSave:R}),(r,e)=>{const c=_("BaseCopyableId"),E=_("BaseInput"),T=_("BaseTextarea"),F=_("BaseCheckbox"),t=_("BaseSelectSearch"),O=_("BaseCodeEditor"),x=_("BaseCommand"),D=_("BaseButton"),de=_("BaseLoader");return o(),u(j,null,[s("div",{class:"modal-overlay",onClick:a},[s("div",{class:oe(["modal",{"full-screen":i(M)}]),onClick:e[11]||(e[11]=U(()=>{},["stop"]))},[s("div",Pe,[s("div",We,y(r.isEditMode?"Редактирование канала":"Новый канал"),1),s("div",Ge,[r.isEditMode?(o(),u("button",{key:0,class:"modal-full-screen",onClick:e[0]||(e[0]=U((...v)=>i(z)&&i(z)(...v),["prevent"]))},[i(M)?(o(),C(i(ge),{key:1})):(o(),C(i(Ve),{key:0}))])):B("",!0),s("button",{class:"modal-close",onClick:U(a,["prevent"])},[b(i(Ie))])])]),r.isEditMode?(o(),C(c,{key:0,class:"ignore-gap",id:r.currentChannelId},null,8,["id"])):B("",!0),s("form",{onSubmit:e[9]||(e[9]=U(()=>A(),["prevent"])),onInput:e[10]||(e[10]=v=>p.value=!0)},[s("div",He,[b(E,{type:"text",required:"",modelValue:n.value.name,"onUpdate:modelValue":e[1]||(e[1]=v=>n.value.name=v),label:"Название *",labelColor:"#FFFFFF",inputClass:"input",class:"dark",error:i(I).name.$error?i(I).name.$errors[0].$message:""},null,8,["modelValue","error"])]),b(T,{modelValue:n.value.description,"onUpdate:modelValue":e[2]||(e[2]=v=>n.value.description=v),class:"custom-textarea",textColor:"#ffffff",backgroundColor:"#212121",border:"none",label:"Описание"},null,8,["modelValue"]),b(F,{"label-color":"#fff",modelValue:n.value.is_public,"onUpdate:modelValue":e[3]||(e[3]=v=>n.value.is_public=v),class:"custom-checkbox"},{default:J(()=>e[12]||(e[12]=[Y(" Публичный канал ")])),_:1},8,["modelValue"]),b(t,{modelValue:n.value.default_bot_id,"onUpdate:modelValue":e[4]||(e[4]=v=>n.value.default_bot_id=v),options:l.value,label:"Выбрать агента","label-color":"#fff",class:"dark"},null,8,["modelValue","options"]),r.isEditMode?(o(),C(O,{key:0,label:"Переменные",modelValue:n.value.variables,"onUpdate:modelValue":e[5]||(e[5]=v=>n.value.variables=v),language:"json",defaultHeight:150,onInput:e[6]||(e[6]=v=>p.value=!0),"is-collapsed":!1,"is-resizable":!1},null,8,["modelValue"])):B("",!0),r.isEditMode?(o(),C(Je,{key:1,modelValue:n.value.subscribers,"onUpdate:modelValue":e[7]||(e[7]=v=>n.value.subscribers=v),onInput:e[8]||(e[8]=v=>p.value=!0)},null,8,["modelValue"])):B("",!0),s("div",Ke,[b(x,{command:"S"}),p.value?(o(),C(D,{key:0,styleType:"secondary",size:"medium",type:"button",onClick:a,disabled:f.value},{default:J(()=>e[13]||(e[13]=[Y(" Закрыть ")])),_:1},8,["disabled"])):B("",!0),b(D,{styleType:"secondary",size:"medium",type:"submit",disabled:f.value,style:{"max-height":"40px"}},{default:J(()=>[f.value?(o(),C(de,{key:0})):(o(),u("span",Xe,y(r.isEditMode?p.value?"Сохранить и закрыть":"Закрыть":"Создать"),1))]),_:1},8,["disabled"])])],32)],2)]),g.value?(o(),C(Me,{key:0,onClose:N,onConfirm:A,onCloseMain:d})):B("",!0)],64)}}}),Ze=ee(Ye,[["__scopeId","data-v-bee115f0"]]),es={class:"pages-component"},ss={class:"container"},as={class:"content-block"},ts={key:1,class:"card-container"},os=["onClick"],ns={class:"channel-actions"},ls={class:"channel-action"},is={class:"channel-action"},ds={class:"card-content"},rs={class:"channel-description"},us={class:"date-subscribers"},cs={class:"subscribers-count"},ms={key:0,class:"right-panel"},ps=ne({__name:"channelsPage",setup(q){pe(e=>({"5db4293a":L.value}));const $=ie(),m=se(),{isModalOpen:S,isEditMode:V,openModal:k,openEditModal:p,closeModal:g}=ke(),f=h(null),n=h({...Z}),{channels:I}=ve($),M=h(!0),z=fe("resize-bar"),L=P(()=>{var e;return(e=z.value)==null?void 0:e.width});le(async()=>{await $.readChannels(),M.value=!1,m.bots.length===0&&m.readBots()});const{sortOption:l,sortOptions:d,searchQuery:a,sortedItems:N,addRecentItem:A}=Be(()=>I.value,void 0,"channel"),R=async e=>{var x;p();const{id:c,created_at:E,updated_at:T,owner:F,default_bot:t,...O}=e;Object.assign(n.value,{...O,variables:JSON.stringify(((x=e.variables)==null?void 0:x.data)||{},null,2)}),f.value=e.id},W=()=>{g(),G()},G=()=>{n.value={...Z}},H=async e=>{confirm("Вы уверены, что хотите удалить этот канал?")&&await $.deleteChannel(e)&&Q.success("Канал удален!")},w=h(null),K=e=>{w.value=e,A(e.id,e.name)},r=()=>{w.value=null};return(e,c)=>{const E=_("BaseSortButtons"),T=_("BaseLoader"),F=_("BaseResizeBar");return o(),u(j,null,[s("div",es,[s("div",ss,[b(Ce),s("div",as,[s("div",{class:"card create-card",onClick:c[0]||(c[0]=(...t)=>i(k)&&i(k)(...t))},[b(i(ye),{class:"icon"}),c[3]||(c[3]=s("div",{class:"text"},[s("span",null,"Новый канал"),s("span",{class:"subtitle"},"Прототипирование и сборка")],-1))]),b(E,{modelValue:i(l),"onUpdate:modelValue":c[1]||(c[1]=t=>ae(l)?l.value=t:null),searchQuery:i(a),"onUpdate:searchQuery":c[2]||(c[2]=t=>ae(a)?a.value=t:null),isSearch:!0,options:i(d)},null,8,["modelValue","searchQuery","options"]),M.value?(o(),C(T,{key:0})):(o(),u("div",ts,[(o(!0),u(j,null,X(i(N),t=>{var O,x;return o(),u("div",{key:t.id,class:"card",onClick:D=>K(t)},[s("div",ns,[s("div",ls,[b(i(be),{class:"icon edit-icon",onClick:U(D=>R(t),["stop"])},null,8,["onClick"])]),s("div",is,[b(i(_e),{class:"icon",onClick:U(D=>H(t.id),["stop"])},null,8,["onClick"])])]),s("h3",null,y(t.name),1),s("div",ds,[s("span",rs,y(t==null?void 0:t.description),1),s("span",null,"Публичный: "+y(t.is_public?"Да":"Нет"),1),s("span",null,"Владелец: "+y((O=t.owner)==null?void 0:O.username),1),s("div",us,[s("span",null,y(i(l)==="newest"?`Создан ${i(te)(t.created_at)}`:`Изменен ${i(te)(t.updated_at)}`),1),s("span",cs,[c[4]||(c[4]=s("i",{class:"fa-solid fa-cube"},null,-1)),Y(" "+y(((x=t.subscribers)==null?void 0:x.filter(D=>D.type==="bot").length)||0),1)])])])],8,os)}),128))]))]),w.value?(o(),u("div",ms,[b(F,{ref:"resize-bar","init-value":500,max:1e3,min:400,position:"left"},null,512),(o(),C(he,{key:w.value.id,channel:w.value,onClose:r,onEdit:R},null,8,["channel"]))])):B("",!0)])]),i(S)?(o(),C(Ze,{key:0,isEditMode:i(V),formData:n.value,currentChannelId:f.value,onClose:W},null,8,["isEditMode","formData","currentChannelId"])):B("",!0)],64)}}}),Vs=ee(ps,[["__scopeId","data-v-d3da11df"]]);export{Vs as default};
