import{C as ue,i as L,r as C,k as R,o as f,a as w,b as s,l as E,f as d,u as v,t as b,p as V,g as re,ac as ne,n as P,d as F,w as _,q as k,_ as K,c as de,j as ie,m as g,F as me}from"./index-SnOBJRe6.js";import{u as ce,F as pe,S as ve}from"./useFullScreen-BNunA2HP.js";import{C as Q,e as fe,u as be,c as Fe}from"./useKeyboardShortcuts-DkxLRe_B.js";import{s as z,b as D,c as ye}from"./useUsersStore-DeqpMyJa.js";import{u as qe,r as Ce}from"./vuelidate-BXQAJ37Y.js";import{u as ge}from"./useGeneratedEntityName-CxA6RL77.js";const N={readRequests(o={}){return z(D.get("/requests/",{params:o}))},createRequest(o){return z(D.post("/requests/",o))},updateRequest(o,r){return z(D.patch(`/requests/${o}`,r))},deleteRequest(o){return z(D.delete(`/requests/${o}`))},executeRequest(o,r,n){const $={variables:r||{},bot_id:o,dry_run:n||!1};return z(D.post(`/requests/${o}/execute`,$))}},W=ue("requests",{state:()=>({requests:[]}),actions:{async readRequests(o={}){const r=await N.readRequests(o);return r&&(this.requests=r.data),r},async createRequest(o){const r=await N.createRequest(o);return r&&this.requests.push(r.data),r.data},async updateRequest(o,r){const n=await N.updateRequest(o,r);return n&&ye(this.requests,o,n.data),n},async deleteRequest(o){const r=await N.deleteRequest(o);return r&&(this.requests=this.requests.filter(n=>n.id!==o)),r},async executeRequest(o,r,n){return await N.executeRequest(o,r,n)}}}),Re={class:"modal-head"},Ve={class:"modal-options"},ke={class:"request-info"},$e={class:"execute-options"},xe={class:"checkbox-label"},Be={key:0,class:"execute-result"},Ee={class:"result-info"},Se={class:"result-time"},Me={key:0,class:"error-message"},Ie={class:"modal-actions"},_e=L({__name:"requestExecuteModal",props:{request:{}},emits:["close","result"],setup(o,{emit:r}){const n=o,$=r,S=W(),m=C(!1),i=C(null),y=C(!1),c=C({channel:{},user:{},bot:{},session:{}}),l=()=>{i.value=null,$("close")},J=async()=>{var p;if(!((p=n.request)!=null&&p.id)){k.error("Невозможно выполнить запрос: ID не найден");return}m.value=!0,i.value=null;try{const t=await S.executeRequest(n.request.id,c.value,y.value);if(t!=null&&t.data){i.value=t.data;const x=y.value?"проверка подстановки":"выполнение запроса";k.success(`${x} выполнена успешно!`),$("result",t.data)}else k.error("Не удалось выполнить запрос")}catch(t){k.error("Ошибка при выполнении запроса: "+(t.message||"Неизвестная ошибка")),i.value={status:0,statusText:"Error",headers:{},data:null,responseTime:0,success:!1,error:t.message||"Неизвестная ошибка"}}finally{m.value=!1}};return(p,t)=>{var q,B,H,T;const x=R("BaseCodeEditor"),O=R("BaseButton");return f(),w("div",{class:"modal-overlay",onClick:l},[s("div",{class:"modal",onClick:t[2]||(t[2]=E(()=>{},["stop"]))},[s("div",Re,[t[3]||(t[3]=s("div",{class:"modal-name"},"Выполнение запроса",-1)),s("div",Ve,[s("button",{class:"modal-close",onClick:E(l,["prevent"])},[d(v(Q))])])]),s("form",{onSubmit:E(J,["prevent"])},[s("div",ke,[s("h3",null,b(((q=p.request)==null?void 0:q.name)||"Неизвестный запрос"),1),s("p",null,[t[4]||(t[4]=s("strong",null,"URL:",-1)),V(" "+b((B=p.request)==null?void 0:B.request_url),1)]),s("p",null,[t[5]||(t[5]=s("strong",null,"Метод:",-1)),V(" "+b((T=(H=p.request)==null?void 0:H.method)==null?void 0:T.toUpperCase()),1)])]),d(x,{modelValue:c.value,"onUpdate:modelValue":t[0]||(t[0]=M=>c.value=M),defaultHeight:200,isCollapsed:!1,isResizable:!0,label:"Variables",labelColor:"#FFFFFF",language:"json"},null,8,["modelValue"]),s("div",$e,[s("label",xe,[re(s("input",{"onUpdate:modelValue":t[1]||(t[1]=M=>y.value=M),type:"checkbox",class:"checkbox-input"},null,512),[[ne,y.value]]),t[6]||(t[6]=s("span",{class:"checkbox-text"},"Dry Run (только проверить подстановку переменных)",-1))])]),i.value?(f(),w("div",Be,[t[7]||(t[7]=s("h4",null,"Результат выполнения запроса:",-1)),s("div",Ee,[s("div",{class:P(["result-status",{success:i.value.success,error:!i.value.success}])}," Статус: "+b(i.value.status)+" "+b(i.value.statusText),3),s("div",Se,"Время выполнения: "+b(i.value.responseTime)+"мс",1)]),d(x,{"model-value":JSON.stringify(i.value.data,null,2),defaultHeight:200,isCollapsed:!1,isResizable:!0,label:"Ответ",labelColor:"#FFFFFF",language:"json",readonly:!0},null,8,["model-value"]),i.value.error?(f(),w("div",Me," Ошибка: "+b(i.value.error),1)):F("",!0)])):F("",!0),s("div",Ie,[d(O,{size:"medium",styleType:"secondary",type:"button",onClick:l},{default:_(()=>t[8]||(t[8]=[V(" Закрыть ")])),_:1}),d(O,{size:"medium",styleType:"primary",type:"submit",disabled:m.value},{default:_(()=>[V(b(m.value?"Выполняется...":y.value?"Проверить подстановку":"Выполнить запрос"),1)]),_:1},8,["disabled"])])],32)])])}}}),we=K(_e,[["__scopeId","data-v-cb42f11e"]]),Te={class:"modal-head"},Ue={class:"modal-name"},je={class:"modal-options"},ze={class:"form-top"},De={key:0,class:"execute-result"},Ne={class:"result-info"},Oe={class:"result-time"},He={key:0,class:"error-message"},he={class:"modal-actions"},Ae=L({__name:"requestModal",props:{isEditMode:{type:Boolean},formData:{},currentRequestId:{}},emits:["close"],setup(o,{emit:r}){const n=o,$=r,S=W(),m=C(!1),i=C(!1),y=C(!1),c=C(null),l=C({...fe,...n.formData}),J=de(()=>n.currentRequestId&&S.requests.find(u=>u.id===n.currentRequestId)||null),p=qe(Ce,l),{isFullScreen:t,toggleFullScreen:x,resetFullScreen:O}=ce(),q=()=>{m.value=!1,O(),$("close")},B=()=>{m.value?i.value=!0:q()},H=()=>{i.value=!1},T=async(u=!1)=>{if(u||m.value){if(!await p.value.$validate()){k.error("Ошибка!");return}await M()}q()},M=async()=>{n.isEditMode&&n.currentRequestId?await Y():await X()},G=u=>Object.fromEntries(Object.entries(u).map(([e,U])=>[e,U===""?null:U])),X=async()=>{const u=G(l.value);await S.createRequest(u)&&(k.success("Реквест создан!"),q())},Y=async()=>{const u=G(l.value);await S.updateRequest(n.currentRequestId,u)&&(k.success("Сохранено!"),q())},Z=async()=>{confirm("Вы уверены, что хотите удалить этот реквест?")&&await S.deleteRequest(n.currentRequestId)&&(k.success("Реквест удален!"),q())},ee=()=>{y.value=!0},se=()=>{y.value=!1},le=u=>{c.value=u},h=u=>typeof u=="string"&&u.trim()||typeof u=="object"&&u&&Object.keys(u).length?"#FFFFFF":"#B3B3B3",{generateName:te}=ge();return ie(()=>{n.isEditMode||(l.value.name=te("реквест"),m.value=!0)}),be({onEscape:B,onSave:M}),(u,e)=>{const U=R("BaseCopyableId"),I=R("BaseInput"),ae=R("BaseSelect"),j=R("BaseCodeEditor"),A=R("BaseButton"),oe=R("BaseCommand");return f(),w(me,null,[s("div",{class:"modal-overlay",onClick:B},[s("div",{class:P(["modal",{"full-screen":v(t)}]),onClick:e[18]||(e[18]=E(()=>{},["stop"]))},[s("div",Te,[s("div",Ue,b(u.isEditMode?"Редактирование реквеста":"Новый реквест"),1),s("div",je,[s("button",{class:"modal-full-screen",onClick:e[0]||(e[0]=E((...a)=>v(x)&&v(x)(...a),["prevent"]))},[v(t)?(f(),g(v(ve),{key:1})):(f(),g(v(pe),{key:0}))]),s("button",{class:"modal-close",onClick:E(B,["prevent"])},[d(v(Q))])])]),u.isEditMode?(f(),g(U,{key:0,id:u.currentRequestId,class:"ignore-gap"},null,8,["id"])):F("",!0),s("form",{onInput:e[16]||(e[16]=a=>m.value=!0),onSubmit:e[17]||(e[17]=E(a=>T(),["prevent"]))},[s("div",ze,[d(I,{modelValue:l.value.name,"onUpdate:modelValue":e[1]||(e[1]=a=>l.value.name=a),class:"dark",label:"Название реквеста *",labelColor:"#FFFFFF",error:v(p).name.$error?v(p).name.$errors[0].$message:""},null,8,["modelValue","error"]),d(ae,{modelValue:l.value.method,"onUpdate:modelValue":e[2]||(e[2]=a=>l.value.method=a),options:[{value:"get",label:"GET"},{value:"post",label:"POST"}],class:"dark",label:"Метод *",labelColor:"#FFFFFF",error:v(p).method.$error?v(p).method.$errors[0].$message:""},null,8,["modelValue","error"])]),d(I,{modelValue:l.value.request_url,"onUpdate:modelValue":e[3]||(e[3]=a=>l.value.request_url=a),class:"dark",label:"Request Url *",labelColor:"#FFFFFF",error:v(p).request_url.$error?v(p).request_url.$errors[0].$message:""},null,8,["modelValue","error"]),d(I,{modelValue:l.value.content,"onUpdate:modelValue":e[4]||(e[4]=a=>l.value.content=a),class:"dark",label:"Content",labelColor:"#FFFFFF"},null,8,["modelValue"]),d(I,{modelValue:l.value.headers,"onUpdate:modelValue":e[5]||(e[5]=a=>l.value.headers=a),class:"dark",label:"Headers",labelColor:"#FFFFFF"},null,8,["modelValue"]),d(I,{modelValue:l.value.attachments,"onUpdate:modelValue":e[6]||(e[6]=a=>l.value.attachments=a),class:"dark",label:"Attachments",labelColor:"#FFFFFF"},null,8,["modelValue"]),d(I,{modelValue:l.value.proxies,"onUpdate:modelValue":e[7]||(e[7]=a=>l.value.proxies=a),class:"dark",label:"Proxies",labelColor:"#FFFFFF"},null,8,["modelValue"]),d(j,{modelValue:l.value.json_field,"onUpdate:modelValue":e[8]||(e[8]=a=>l.value.json_field=a),defaultHeight:100,isCollapsed:!0,isResizable:!0,label:"Json field",labelColor:h(l.value.json_field||""),language:"json",onInput:e[9]||(e[9]=a=>m.value=!0)},null,8,["modelValue","labelColor"]),d(j,{modelValue:l.value.params,"onUpdate:modelValue":e[10]||(e[10]=a=>l.value.params=a),defaultHeight:100,isCollapsed:!0,isResizable:!0,label:"Параметры",labelColor:h(l.value.params),language:"json",onInput:e[11]||(e[11]=a=>m.value=!0)},null,8,["modelValue","labelColor"]),d(j,{modelValue:l.value.data,"onUpdate:modelValue":e[12]||(e[12]=a=>l.value.data=a),defaultHeight:100,isCollapsed:!0,isResizable:!0,label:"Data",labelColor:h(l.value.data),language:"json",onInput:e[13]||(e[13]=a=>m.value=!0)},null,8,["modelValue","labelColor"]),d(j,{modelValue:l.value.url_params,"onUpdate:modelValue":e[14]||(e[14]=a=>l.value.url_params=a),defaultHeight:100,isCollapsed:!0,isResizable:!0,label:"Url Params",labelColor:h(l.value.url_params),language:"json",onInput:e[15]||(e[15]=a=>m.value=!0)},null,8,["modelValue","labelColor"]),c.value?(f(),w("div",De,[e[19]||(e[19]=s("h4",null,"Результат выполнения запроса:",-1)),s("div",Ne,[s("div",{class:P(["result-status",{success:c.value.success,error:!c.value.success}])}," Статус: "+b(c.value.status)+" "+b(c.value.statusText),3),s("div",Oe,"Время выполнения: "+b(c.value.responseTime)+"мс",1)]),d(j,{"model-value":JSON.stringify(c.value.data,null,2),defaultHeight:200,isCollapsed:!1,isResizable:!0,label:"Ответ",labelColor:"#FFFFFF",language:"json",readonly:!0},null,8,["model-value"]),c.value.error?(f(),w("div",He," Ошибка: "+b(c.value.error),1)):F("",!0)])):F("",!0),s("div",he,[u.isEditMode?(f(),g(A,{key:0,size:"medium",styleType:"danger",type:"button",onClick:Z,style:{"margin-right":"auto"}},{default:_(()=>e[20]||(e[20]=[V(" Удалить ")])),_:1})):F("",!0),u.isEditMode?(f(),g(A,{key:1,size:"medium",styleType:"success",type:"button",onClick:ee,style:{"margin-right":"auto"}},{default:_(()=>e[21]||(e[21]=[V(" Execute ")])),_:1})):F("",!0),d(oe,{command:"S"}),m.value?(f(),g(A,{key:2,size:"medium",styleType:"secondary",type:"button",onClick:B},{default:_(()=>e[22]||(e[22]=[V(" Закрыть ")])),_:1})):F("",!0),d(A,{size:"medium",styleType:"primary",type:"submit"},{default:_(()=>[V(b(u.isEditMode?m.value?"Сохранить и закрыть":"Закрыть":"Создать"),1)]),_:1})])],32)],2)]),i.value?(f(),g(Fe,{key:0,onClose:H,onConfirm:T,onCloseMain:q})):F("",!0),y.value?(f(),g(we,{key:1,request:J.value,onClose:se,onResult:le},null,8,["request"])):F("",!0)],64)}}}),We=K(Ae,[["__scopeId","data-v-95b52a9c"]]);export{We as r,W as u};
