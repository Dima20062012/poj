import{i as j,r as _,j as ee,k as D,o as r,a as B,b as e,n as ce,l as O,t as m,f as p,u as l,m as x,d as h,w as X,p as S,F as U,q as F,_ as G,x as se,D as ue,g as pe,ab as me,e as oe,B as ve,z as Y}from"./index-SnOBJRe6.js";import{u as A,E as fe,T as ye}from"./useBotsStore-CXWqdG9t.js";import{s as _e,F as Be}from"./pages.css_vue_type_style_index_0_src_true_lang-OrqQe0zQ.js";import{B as Ce,D as ke}from"./BotImportDropzone-CzOBMZNw.js";import"./useUsersStore-DeqpMyJa.js";import{u as be,a as $e,f as Z}from"./useSorting-Bi68fFlD.js";import{a as P,u as Me,C as he,c as Ie}from"./useKeyboardShortcuts-DkxLRe_B.js";import{u as ge,b as we}from"./vuelidate-BXQAJ37Y.js";import{u as De}from"./useGeneratedEntityName-CxA6RL77.js";const Se={class:"modal-head"},Fe={class:"modal-name"},Oe={class:"modal-options"},Ee={class:"form-top"},Ve={class:"modal-actions"},Re=j({__name:"botModal",props:{isEditMode:{type:Boolean},formData:{},currentBotId:{}},emits:["close"],setup(T,{emit:R}){const c=T,I=R,M=A(),v=_(!1),d=_(!1),t=_({...P,...c.formData}),u=ge(we,t),f=()=>{v.value=!1,I("close")},C=()=>{v.value?d.value=!0:f()},y=()=>{d.value=!1},s=async(b=!1)=>{if(b||v.value){if(!await u.value.$validate()){F.error("Ошибка!");return}await k()}f()},k=async()=>{c.isEditMode&&c.currentBotId?await L():await E()},E=async()=>{await M.createBot(t.value)&&(F.success("Агент создан!"),f())},L=async()=>{await M.updateBot(c.currentBotId,t.value)&&(F.success("Сохранено!"),f())},{generateName:V}=De();return ee(()=>{c.isEditMode||(t.value.name=V("агент"),v.value=!0)}),Me({onEscape:C,onSave:s}),(b,i)=>{const N=D("BaseCopyableId"),Q=D("BaseInput"),q=D("BaseTextarea"),J=D("BaseCommand"),z=D("BaseButton");return r(),B(U,null,[e("div",{class:"modal-overlay",onClick:C},[e("div",{class:ce("modal"),onClick:i[4]||(i[4]=O(()=>{},["stop"]))},[e("div",Se,[e("div",Fe,m(b.isEditMode?"Редактирование агента":"Новый агент"),1),e("div",Oe,[e("button",{class:"modal-close",onClick:O(C,["prevent"])},[p(l(he))])])]),b.isEditMode?(r(),x(N,{key:0,class:"ignore-gap",id:b.currentBotId},null,8,["id"])):h("",!0),e("form",{onSubmit:i[2]||(i[2]=O(w=>s(),["prevent"])),onInput:i[3]||(i[3]=w=>v.value=!0)},[e("div",Ee,[p(Q,{type:"text",required:"",modelValue:t.value.name,"onUpdate:modelValue":i[0]||(i[0]=w=>t.value.name=w),label:"Название *",labelColor:"#FFFFFF",inputClass:"input",class:"dark",error:l(u).name.$error?l(u).name.$errors[0].$message:""},null,8,["modelValue","error"])]),p(q,{modelValue:t.value.description,"onUpdate:modelValue":i[1]||(i[1]=w=>t.value.description=w),class:"custom-textarea",textColor:"#ffffff",backgroundColor:"#212121",border:"none",label:"Описание"},null,8,["modelValue"]),e("div",Ve,[p(J,{command:"S"}),v.value?(r(),x(z,{key:0,styleType:"secondary",size:"medium",type:"button",onClick:C},{default:X(()=>i[5]||(i[5]=[S(" Закрыть ")])),_:1})):h("",!0),p(z,{styleType:"primary",size:"medium",type:"submit"},{default:X(()=>[S(m(b.isEditMode?v.value?"Сохранить и закрыть":"Закрыть":"Создать"),1)]),_:1})])],32)])]),d.value?(r(),x(Ie,{key:0,onClose:y,onConfirm:s,onCloseMain:f})):h("",!0)],64)}}}),xe=G(Re,[["__scopeId","data-v-f9c0d29b"]]),Te={class:"modal-body"},Ne={key:0,class:"file-preview"},ze={class:"preview-content"},Ue={class:"preview-item"},Le={class:"preview-item"},Qe={key:0,class:"preview-item"},qe={class:"bot-selection"},Je=["disabled"],Ke=["value"],Pe={key:1,class:"warning"},je={class:"modal-footer"},Ge=["disabled"],Ae=["disabled"],He={key:0,class:"spinner-small"},We=j({__name:"BotReplaceModal",props:{isOpen:{type:Boolean},fileData:{},onConfirm:{type:Function},onCancel:{type:Function}},emits:["update:isOpen","confirm","cancel"],setup(T,{emit:R}){const c=T,I=R,M=A(),{bots:v}=se(M),d=_(""),t=_(!1),u=()=>{I("update:isOpen",!1),I("cancel"),d.value=""},f=()=>{t.value||u()},C=async()=>{if(d.value){t.value=!0;try{I("confirm",d.value)}finally{t.value=!1}}};return ue(()=>c.isOpen,y=>{y||(d.value="",t.value=!1)}),(y,s)=>y.isOpen?(r(),B("div",{key:0,class:"modal-overlay",onClick:f},[e("div",{class:"modal-content",onClick:s[1]||(s[1]=O(()=>{},["stop"]))},[e("div",{class:"modal-header"},[s[3]||(s[3]=e("h2",null,"Заменить структуру бота",-1)),e("button",{onClick:u,class:"close-btn"},s[2]||(s[2]=[e("i",{class:"fa-solid fa-times"},null,-1)]))]),e("div",Te,[y.fileData?(r(),B("div",Ne,[s[7]||(s[7]=e("h3",null,"Предпросмотр файла:",-1)),e("div",ze,[e("div",Ue,[s[4]||(s[4]=e("strong",null,"Название:",-1)),S(" "+m(y.fileData.name||"Не указано"),1)]),e("div",Le,[s[5]||(s[5]=e("strong",null,"Описание:",-1)),S(" "+m(y.fileData.description||"Не указано"),1)]),y.fileData.steps?(r(),B("div",Qe,[s[6]||(s[6]=e("strong",null,"Количество шагов:",-1)),S(" "+m(y.fileData.steps.length),1)])):h("",!0)])])):h("",!0),e("div",qe,[s[9]||(s[9]=e("label",{for:"bot-select"},"Выберите бота для замены структуры:",-1)),pe(e("select",{id:"bot-select","onUpdate:modelValue":s[0]||(s[0]=k=>d.value=k),class:"bot-select",disabled:t.value},[s[8]||(s[8]=e("option",{value:""},"-- Выберите бота --",-1)),(r(!0),B(U,null,oe(l(v),k=>{var E;return r(),B("option",{key:k.id,value:k.id},m(k.name)+" ("+m(((E=k.steps)==null?void 0:E.length)||0)+" шагов) ",9,Ke)}),128))],8,Je),[[me,d.value]])]),d.value?(r(),B("div",Pe,s[10]||(s[10]=[e("i",{class:"fa-solid fa-exclamation-triangle"},null,-1),e("span",null," Внимание! Это действие заменит структуру выбранного бота. Все существующие шаги и связи будут удалены. ",-1)]))):h("",!0)]),e("div",je,[e("button",{onClick:u,class:"btn btn-secondary",disabled:t.value}," Отмена ",8,Ge),e("button",{onClick:C,class:"btn btn-primary",disabled:!d.value||t.value},[t.value?(r(),B("span",He)):h("",!0),S(" "+m(t.value?"Замена...":"Заменить структуру"),1)],8,Ae)])])])):h("",!0)}}),Xe=G(We,[["__scopeId","data-v-1fd8da3d"]]),Ye={class:"pages-component"},Ze={class:"container"},es={class:"content-block"},ss={class:"import-section"},os={key:1,class:"card-container"},ts=["onClick"],as={class:"channel-actions"},ns={class:"channel-action"},ls={class:"channel-action"},is={class:"channel-action"},rs={class:"card-content"},ds={class:"bot-description"},cs={class:"date-steps"},us={class:"steps-count"},ps=j({__name:"botsPage",setup(T){const R=ve(),c=A(),I=_(null),M=_({...P}),{bots:v}=se(c),d=_(!0),t=_(),u=_(!1),f=_(null),C=_(null),{isModalOpen:y,isEditMode:s,openModal:k,openEditModal:E,closeModal:L}=be(),{sortOption:V,sortOptions:b,searchQuery:i,sortedItems:N,addRecentItem:Q}=$e(()=>v.value,void 0,"bot"),q=a=>{E(),M.value.name=a.name||"",M.value.description=a.description||"",I.value=a.id},J=()=>{L(),z()},z=()=>{M.value={...P}},w=async a=>{confirm("Вы уверены, что хотите удалить этого агента?")&&await c.deleteBot(a)&&F.success("Агент удален!")},te=async a=>{var o,g;try{await c.exportBot(a)&&F.success("Bot exported successfully")}catch($){const n=((g=(o=$==null?void 0:$.response)==null?void 0:o.data)==null?void 0:g.detail)||($==null?void 0:$.message)||"Ошибка при экспорте бота";F.error(n)}},ae=async a=>{C.value=a;try{const o=await a.text(),g=JSON.parse(o);f.value=g,confirm(`Файл "${a.name}" загружен.

Нажмите OK для создания нового бота
Нажмите Отмена для замены структуры существующего бота`)?await t.value.importBot():u.value=!0}catch{F.error("Ошибка при чтении файла. Убедитесь, что это валидный JSON файл.")}},ne=a=>{c.readBots()},le=a=>{console.error("Import error:",a)},ie=async a=>{if(C.value)try{await t.value.importBot(a),u.value=!1,f.value=null,C.value=null}catch(o){console.error("Replace error:",o)}},re=()=>{var a;u.value=!1,f.value=null,C.value=null,(a=t.value)==null||a.clearFile()},de=a=>{const o=v.value.find(g=>g.id===a);o&&Q(o.id,o.name||o.id),R.push({path:`/bot/${a}`})};return ee(async()=>{await c.readBots(),d.value=!1}),(a,o)=>{const g=D("BaseSortButtons"),$=D("BaseLoader");return r(),B(U,null,[e("div",Ye,[e("div",Ze,[p(_e),e("div",es,[e("div",{class:"card create-card",onClick:o[0]||(o[0]=(...n)=>l(k)&&l(k)(...n))},[p(l(Be),{class:"icon"}),o[4]||(o[4]=e("div",{class:"text"},[e("span",null,"Новый агент"),e("span",{class:"subtitle"},"Прототипирование и сборка")],-1))]),e("div",ss,[p(Ce,{ref_key:"importDropzone",ref:t,onFileSelected:ae,onImportSuccess:ne,onImportError:le},null,512)]),p(g,{modelValue:l(V),"onUpdate:modelValue":o[1]||(o[1]=n=>Y(V)?V.value=n:null),searchQuery:l(i),"onUpdate:searchQuery":o[2]||(o[2]=n=>Y(i)?i.value=n:null),isSearch:!0,options:l(b)},null,8,["modelValue","searchQuery","options"]),d.value?(r(),x($,{key:0})):(r(),B("div",os,[(r(!0),B(U,null,oe(l(N),n=>{var H,W;return r(),B("div",{class:"card",key:n.id,onClick:K=>de(n.id)},[e("div",as,[e("div",ns,[p(l(fe),{onClick:O(K=>q(n),["stop"]),class:"icon edit-icon"},null,8,["onClick"])]),e("div",ls,[p(l(ke),{onClick:O(K=>te(n.id),["stop"]),class:"icon export-icon"},null,8,["onClick"])]),e("div",is,[p(l(ye),{onClick:O(K=>w(n.id),["stop"]),class:"icon"},null,8,["onClick"])])]),e("h3",null,m(n.name),1),e("div",rs,[e("span",ds,m(n==null?void 0:n.description),1),e("span",null,"Владелец: "+m(((H=n.owner)==null?void 0:H.username)||"Неизвестно"),1),e("div",cs,[e("span",null,m(l(V)==="newest"?`Создан ${l(Z)(n.created_at)}`:`Изменен ${l(Z)(n.updated_at)}`),1),e("span",us,[o[5]||(o[5]=e("i",{class:"fa-solid fa-shoe-prints fa-rotate-270"},null,-1)),S(" "+m(((W=n.steps)==null?void 0:W.length)||0),1)])])])],8,ts)}),128))]))])])]),l(y)?(r(),x(xe,{key:0,isEditMode:l(s),formData:M.value,currentBotId:I.value,onClose:J},null,8,["isEditMode","formData","currentBotId"])):h("",!0),p(Xe,{isOpen:u.value,"onUpdate:isOpen":o[3]||(o[3]=n=>u.value=n),fileData:f.value,onConfirm:ie,onCancel:re},null,8,["isOpen","fileData"])],64)}}}),$s=G(ps,[["__scopeId","data-v-edab2dfc"]]);export{$s as default};
