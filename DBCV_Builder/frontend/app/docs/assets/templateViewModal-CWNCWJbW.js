import{C as P,_ as z,r as j,D as F,k as $,o as d,a as p,b as s,F as J,e as O,g as A,v as M,ab as Z,f as y,d as k,c as D,j as ee,t as b,l as L,m as te,p as se}from"./index-SnOBJRe6.js";import{s as V,b as h,c as ae}from"./useUsersStore-DeqpMyJa.js";import{u as le}from"./useGeneratedEntityName-CxA6RL77.js";import{u as oe}from"./useBotsStore-CXWqdG9t.js";const U={readTemplates(t={}){return V(h.get("/templates/",{params:t}))},createTemplate(t){return V(h.post("/templates/",t))},readTemplate(t){return V(h.get(`/templates/${t}`))},updateTemplate(t,l){return V(h.patch(`/templates/${t}`,l))},deleteTemplate(t){return V(h.delete(`/templates/${t}`))}},Xe=P("templates",{state:()=>({templates:[]}),actions:{async readTemplates(t={}){const l=await U.readTemplates(t);return l&&(this.templates=l.data),l},async createTemplate(t){const l=await U.createTemplate(t);return l&&this.templates.push(l.data),l},async readTemplate(t){return await U.readTemplate(t)},async updateTemplate(t,l){const a=await U.updateTemplate(t,l);return a&&ae(this.templates,t,a.data),a},async deleteTemplate(t){const l=await U.deleteTemplate(t);return l&&(this.templates=this.templates.filter(a=>a.id!==t)),l}}}),S={readTemplateGroups(t={}){return V(h.get("/template_group/",{params:t}))},readTemplateGroup(t){return V(h.get(`/api/v1/template_group/${t}`))},createTemplateGroup(t){return V(h.post("/template_group/",t))},updateTemplateGroup(t,l){return V(h.patch(`/template_group/${t}`,l))},deleteTemplateGroup(t){return V(h.delete(`/template_group/${t}`))},addTemplateToGroup(t,l){return V(h.post(`/template_group/${t}/add_template/${l}`))},removeTemplateToGroup(t,l){return V(h.post(`/template_group/${t}/remove_template/${l}`))}},Ye=P("templateGroups",{state:()=>({templatesGroups:[]}),actions:{async readTemplateGroups(t={}){const l=await S.readTemplateGroups(t);return l&&(this.templatesGroups=l.data),l},async readTemplateGroup(t){return await S.readTemplateGroup(t)},async createTemplateGroup(t){const l=await S.createTemplateGroup(t);return l&&await this.readTemplateGroups(),l},async updateTemplateGroup(t,l){const a=await S.updateTemplateGroup(t,l);return a&&await this.readTemplateGroups(),a},async deleteTemplateGroup(t){const l=await S.deleteTemplateGroup(t);return l&&await this.readTemplateGroups(),l},async addTemplateToGroup(t,l){const a=await S.addTemplateToGroup(t,l);return a&&await this.readTemplateGroups(),a},async removeTemplateFromGroup(t,l){const a=await S.removeTemplateToGroup(t,l);return a&&await this.readTemplateGroups(),a}}});let E=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce((l,a)=>(a&=63,a<36?l+=a.toString(36):a<62?l+=(a-26).toString(36).toUpperCase():a>62?l+="-":l+="_",l),"");const ie={class:"json-schema-builder"},ne={class:"schema-table"},ue=["onUpdate:modelValue"],de=["onUpdate:modelValue"],re=["onUpdate:modelValue"],pe=["onUpdate:modelValue"],me=["onClick"],ce={key:0},ve={colspan:"6",class:"nested"},be={__name:"JsonSchemaBuilder",props:{modelValue:{type:Array,default:()=>[]},sectionTitle:{type:String,default:"Section 1"}},emits:["update:modelValue"],setup(t,{emit:l}){const a=t,B=l,v=j(a.modelValue.map(e=>({...e,id:e.id||E()})));function T(){v.value.push({id:E(),name:"",type:"string",required:!1,default:"",description:"",properties:[],items:[]}),B("update:modelValue",v.value)}function G(e){v.value.splice(e,1),B("update:modelValue",v.value)}return F(()=>a.modelValue,e=>{(e.length!==v.value.length||e.some((n,_)=>{var g;return n.id!==((g=v.value[_])==null?void 0:g.id)}))&&(v.value=e.map(n=>({...n,id:n.id||E()})))}),F(v,e=>{B("update:modelValue",e)},{deep:!0}),(e,n)=>{const _=$("BaseCheckbox"),g=$("JsonSchemaBuilder",!0);return d(),p("div",ie,[s("table",ne,[n[1]||(n[1]=s("thead",null,[s("tr",null,[s("th",null,"properties"),s("th",null,"type"),s("th",null,"required"),s("th",null,"default"),s("th",null,"description"),s("th")])],-1)),s("tbody",null,[(d(!0),p(J,null,O(v.value,(m,w)=>(d(),p(J,{key:m.id},[s("tr",null,[s("td",null,[A(s("input",{"onUpdate:modelValue":c=>m.name=c,placeholder:"name",class:"input"},null,8,ue),[[M,m.name]])]),s("td",null,[A(s("select",{"onUpdate:modelValue":c=>m.type=c,class:"input"},n[0]||(n[0]=[s("option",{value:"string"},"string",-1),s("option",{value:"number"},"number",-1),s("option",{value:"boolean"},"boolean",-1),s("option",{value:"object"},"object",-1)]),8,de),[[Z,m.type]])]),s("td",null,[y(_,{modelValue:m.required,"onUpdate:modelValue":c=>m.required=c},null,8,["modelValue","onUpdate:modelValue"])]),s("td",null,[m.type!=="object"?A((d(),p("input",{key:0,"onUpdate:modelValue":c=>m.default=c,class:"input"},null,8,re)),[[M,m.default]]):k("",!0)]),s("td",null,[A(s("input",{"onUpdate:modelValue":c=>m.description=c,class:"input"},null,8,pe),[[M,m.description]])]),s("td",null,[s("button",{type:"button",onClick:c=>G(w),class:"remove-btn"},"x",8,me)])]),m.type==="object"?(d(),p("tr",ce,[s("td",ve,[y(g,{modelValue:m.properties,"onUpdate:modelValue":c=>m.properties=c,"is-root":!1,"section-title":"Object properties"},null,8,["modelValue","onUpdate:modelValue"])])])):k("",!0)],64))),128))])]),s("button",{type:"button",onClick:T,class:"add-btn"},"добавить")])}}},K=z(be,[["__scopeId","data-v-dedeea42"]]),_e={class:"modal"},fe={class:"modal-head"},ye={class:"modal-title"},Ve={key:0,class:"form-group id-group"},he={key:1,class:"form-group id-group"},Te={class:"form-group"},ge={key:0,class:"no-steps"},ke={key:1,class:"custom-multiselect"},Be={class:"select-list"},$e={key:0,class:"selected-steps"},Ie={class:"form-group"},Se={class:"form-group"},Ge={class:"modal-footer"},we=["disabled"],Ce={key:1,class:"error"},Ue={__name:"templateModal",props:{steps:{type:Array,default:()=>[]},initial:{type:Object,default:null},botId:{type:String,default:null}},emits:["close","save"],setup(t,{emit:l}){const a=t,B=l,v=oe(),T=D(()=>!!a.initial),G=j(!1),e=j({name:"",description:"",variablesJson:"{}",inputs:[],outputs:[],step_ids:[],first_step_id:"",selectedBotId:a.botId||""}),n=j([]),_=j(""),{generateName:g}=le(),m=D(()=>{const i=v.bots.map(o=>({label:o.name,value:o.id}));return i.unshift({label:"Выберите агента",value:""}),i}),w=D(()=>n.value.filter(i=>e.value.step_ids.includes(i.id)).map(i=>({label:i.name,value:i.id}))),c=()=>{if(!e.value.selectedBotId){n.value=[];return}const i=v.bots.find(o=>o.id===e.value.selectedBotId);n.value=(i==null?void 0:i.steps)||[]};ee(async()=>{!a.botId&&v.bots.length===0&&await v.readBots(),a.initial?(e.value.name=a.initial.name||"",e.value.description=a.initial.description||"",e.value.variablesJson=JSON.stringify(a.initial.variables||{},null,2),e.value.inputs=C(a.initial.inputs),e.value.outputs=C(a.initial.outputs),e.value.step_ids=Array.isArray(a.initial.steps)?a.initial.steps.map(i=>i.id):[],e.value.first_step_id=a.initial.first_step_id||"",a.botId?(e.value.selectedBotId=a.botId,n.value=a.steps):a.initial.bot_id&&(e.value.selectedBotId=a.initial.bot_id,await loadBotSteps())):(e.value.name=g("шаблон"),a.botId&&(e.value.selectedBotId=a.botId,n.value=a.steps))}),F(()=>a.initial,async i=>{i&&(e.value.name=i.name||"",e.value.description=i.description||"",e.value.variablesJson=JSON.stringify(i.variables||{},null,2),e.value.inputs=C(i.inputs),e.value.outputs=C(i.outputs),e.value.step_ids=Array.isArray(i.steps)?i.steps.map(o=>o.id):[],e.value.first_step_id=i.first_step_id||"",a.initial.bot_id&&!a.botId&&(e.value.selectedBotId=a.initial.bot_id,await loadBotSteps()))});function x(){B("close")}function Q(){if(_.value="",!e.value.name.trim()){_.value="Название обязательно";return}if(!a.botId&&!e.value.selectedBotId){_.value="Выберите агента";return}if(!e.value.step_ids.length){_.value="Выберите хотя бы один шаг";return}if(!e.value.first_step_id){_.value="Выберите первый шаг";return}let i;try{i=JSON.parse(e.value.variablesJson||"{}")}catch{_.value="Variables должны быть валидным JSON";return}B("save",{name:e.value.name,description:e.value.description,variables:i,inputs:N(e.value.inputs),outputs:N(e.value.outputs),step_ids:Array.isArray(e.value.step_ids)?e.value.step_ids:[e.value.step_ids],first_step_id:e.value.first_step_id,bot_id:a.botId||e.value.selectedBotId})}function N(i){const o={type:"object",properties:{},required:[]};for(const u of i){const f={type:u.type};if(u.default!==""&&(f.default=u.default),u.description&&(f.description=u.description),u.type==="object"){const I=N(u.properties);f.properties=I.properties,I.required&&I.required.length>0&&(f.required=I.required)}o.properties[u.name]=f,u.required&&o.required.push(u.name)}return o}function C(i){return!i||!i.properties?[]:Object.entries(i.properties).map(([o,u])=>{const f={id:o+"-"+Math.random().toString(36).slice(2,8),name:o,type:u.type,required:Array.isArray(i.required)?i.required.includes(o):!1,default:u.default??"",description:u.description??"",properties:[],items:[]};return u.type==="object"&&(f.properties=C(u)),u.type==="array"&&(f.items=u.items?C({type:"object",properties:{item:u.items},required:[]}):[]),f})}return(i,o)=>{var R,H;const u=$("BaseCopyableId"),f=$("BaseInput"),I=$("BaseSelect"),W=$("BaseCheckbox"),X=$("BaseCodeEditor");return d(),p("div",{class:"modal-overlay",onClick:L(x,["self"])},[s("div",_e,[s("div",fe,[s("div",ye,b(T.value?"Редактировать шаблон":"Создать шаблон"),1),s("button",{class:"modal-close",onClick:x},"×")]),T.value&&((R=a.initial)!=null&&R.id)?(d(),p("div",Ve,[o[8]||(o[8]=s("label",null,"ID шаблона:",-1)),y(u,{id:a.initial.id},null,8,["id"])])):k("",!0),T.value&&((H=a.initial)!=null&&H.bot_id)?(d(),p("div",he,[o[9]||(o[9]=s("label",null,"ID агента шаблона:",-1)),y(u,{id:a.initial.bot_id},null,8,["id"])])):k("",!0),s("form",{onSubmit:L(Q,["prevent"])},[y(f,{modelValue:e.value.name,"onUpdate:modelValue":o[0]||(o[0]=r=>e.value.name=r),required:"",label:"Название *",class:"dark"},null,8,["modelValue"]),y(f,{modelValue:e.value.description,"onUpdate:modelValue":o[1]||(o[1]=r=>e.value.description=r),label:"Описание",class:"dark"},null,8,["modelValue"]),a.botId?k("",!0):(d(),te(I,{key:0,modelValue:e.value.selectedBotId,"onUpdate:modelValue":[o[2]||(o[2]=r=>e.value.selectedBotId=r),c],options:m.value,label:"Выбрать агента *","label-color":"#fff",class:"dark"},null,8,["modelValue","options"])),s("div",Te,[o[10]||(o[10]=s("label",null,"Шаги (выберите шаги для шаблона) *",-1)),n.value.length===0?(d(),p("div",ge,b(e.value.selectedBotId?"У выбранного агента нет шагов":"Выберите агента для загрузки шагов"),1)):(d(),p("div",ke,[s("div",Be,[(d(!0),p(J,null,O(n.value,r=>(d(),p("label",{key:r.id,class:"select-item"},[y(W,{modelValue:e.value.step_ids,"onUpdate:modelValue":o[3]||(o[3]=q=>e.value.step_ids=q),value:r.id,variant:"green"},null,8,["modelValue","value"]),s("span",null,b(r.name),1)]))),128))]),e.value.step_ids.length?(d(),p("div",$e,[(d(!0),p(J,null,O(e.value.step_ids,r=>{var q;return d(),p("span",{key:r,class:"selected-step"},b(((q=n.value.find(Y=>Y.id===r))==null?void 0:q.name)||r),1)}),128))])):k("",!0)]))]),y(I,{modelValue:e.value.first_step_id,"onUpdate:modelValue":o[4]||(o[4]=r=>e.value.first_step_id=r),options:w.value,label:"Первый шаг *","label-color":"#fff",class:"dark",disabled:!e.value.step_ids.length},null,8,["modelValue","options","disabled"]),y(X,{"default-height":100,"is-collapsed":!1,"is-resizable":!1,modelValue:e.value.variablesJson,"onUpdate:modelValue":o[5]||(o[5]=r=>e.value.variablesJson=r),label:"Variables (JSON)",language:"json",height:"120px"},null,8,["modelValue"]),s("div",Ie,[o[11]||(o[11]=s("label",null,"Inputs",-1)),y(K,{modelValue:e.value.inputs,"onUpdate:modelValue":o[6]||(o[6]=r=>e.value.inputs=r),"section-title":"Inputs"},null,8,["modelValue"])]),s("div",Se,[o[12]||(o[12]=s("label",null,"Outputs",-1)),y(K,{modelValue:e.value.outputs,"onUpdate:modelValue":o[7]||(o[7]=r=>e.value.outputs=r),"section-title":"Outputs"},null,8,["modelValue"])]),s("div",Ge,[s("button",{type:"button",class:"btn secondary",onClick:x},"Отмена"),s("button",{type:"submit",class:"btn primary",disabled:G.value},b(G.value?"Загрузка...":T.value?"Сохранить":"Создать"),9,we)]),_.value?(d(),p("div",Ce,b(_.value),1)):k("",!0)],32)])])}}},Ze=z(Ue,[["__scopeId","data-v-9d53683c"]]),je={class:"modal"},Je={class:"modal-head"},qe={class:"modal-title"},Ae={class:"modal-section copyable-id"},Oe={class:"modal-section"},xe={class:"modal-section"},Ne={key:0},Me={class:"modal-section"},De={class:"modal-section"},Ee={class:"json-block"},Fe={class:"modal-section"},Le={class:"json-block"},ze={class:"modal-section"},Re={class:"json-block"},He={__name:"templateViewModal",props:{template:Object},emits:["close"],setup(t,{emit:l}){const a=t,B=l;function v(){B("close")}function T(e){try{return JSON.stringify(e,null,2)}catch{return String(e)}}function G(){var e;(e=a.template)!=null&&e.bot_id&&window.open(`/bot/${a.template.bot_id}`,"_blank")}return(e,n)=>{var g,m,w;const _=$("BaseCopyableId");return d(),p("div",{class:"modal-overlay",onClick:L(v,["self"])},[s("div",je,[s("div",Je,[s("div",qe,"Шаблон: "+b(t.template.name),1),s("button",{class:"modal-close",onClick:v},"×")]),s("div",Ae,[y(_,{id:t.template.id},null,8,["id"])]),s("div",Oe,[n[0]||(n[0]=s("div",{class:"section-label"},"Описание:",-1)),s("div",null,b(t.template.description||"—"),1)]),(g=t.template)!=null&&g.bot_id?(d(),p("button",{key:0,onClick:G,class:"btn primary"}," Перейти к агенту для редактирования ")):k("",!0),s("div",xe,[n[1]||(n[1]=s("div",{class:"section-label"},"Первый шаг:",-1)),s("div",null,[se(b(((w=(m=t.template.steps)==null?void 0:m.find(c=>c.id===t.template.first_step_id))==null?void 0:w.name)||t.template.first_step_id)+" ",1),t.template.first_step_id?(d(),p("span",Ne,"("+b(t.template.first_step_id)+")",1)):k("",!0)])]),s("div",Me,[n[2]||(n[2]=s("div",{class:"section-label"},"Шаги:",-1)),s("ul",null,[(d(!0),p(J,null,O(t.template.steps,c=>(d(),p("li",{key:c.id},b(c.name)+" ("+b(c.id)+")",1))),128))])]),s("div",De,[n[3]||(n[3]=s("div",{class:"section-label"},"Переменные:",-1)),s("pre",Ee,b(T(t.template.variables)),1)]),s("div",Fe,[n[4]||(n[4]=s("div",{class:"section-label"},"Inputs:",-1)),s("pre",Le,b(T(t.template.inputs)),1)]),s("div",ze,[n[5]||(n[5]=s("div",{class:"section-label"},"Outputs:",-1)),s("pre",Re,b(T(t.template.outputs)),1)])])])}}},et=z(He,[["__scopeId","data-v-c476464c"]]);export{et as a,Ye as b,E as n,Ze as t,Xe as u};
